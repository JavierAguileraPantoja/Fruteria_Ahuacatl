<%- include('layout/header') %>

<style>
  .tabla-scroll {
    max-height: 500px;
    overflow-y: auto;
  }
  .tabla-scroll thead {
    position: sticky;
    top: 0;
    z-index: 2;
  }
</style>

<div class="container my-4">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-success text-white d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <h4 class="mb-0">
        <i class="fas fa-apple-alt me-2"></i>Gestión de Productos
      </h4>

      <% if (user && (user.role === 'administrador' || user.role === 'bodeguero')) { %>
        <a href="/productos/add" class="btn btn-light btn-sm shadow-sm">
          <i class="fas fa-plus-circle me-1"></i>Agregar
        </a>
      <% } %>
    </div>
  </div>

  <div class="card-body p-3 p-md-4">

    <% if (message) { %>
      <div class="alert alert-dismissible fade show alert-<%= message.type %>" role="alert">
        <strong><%= message.message %></strong>
        <button class="btn-close" type="button" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- PROTECCIÓN ANTI-DUPLICADO: NO DataTables, NO AJAX -->
    <script>
      // Bloquear cualquier intento de DataTable automático
      window.onload = () => {
        const posibleDT = $('#tablaProductos').DataTable;
        if (posibleDT) {
          console.warn("⚠ DataTable detectado. Se bloquea para evitar duplicados.");
          $('#tablaProductos').DataTable = function () { return null; };
        }
      };
    </script>

    <div class="table-responsive tabla-scroll">
      <table class="table table-hover align-middle text-center" id="tablaProductos">
        <thead class="table-success">
          <tr>
            <th>#</th>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Compra</th>
            <th>Venta</th>
            <th>Stock</th>
            <th>Unidad</th>
            <% if (user.role !== 'vendedor') { %>
              <th>Acciones</th>
            <% } %>
          </tr>
        </thead>

        <tbody>
          <% if (productos.length > 0) { %>
            <% productos.forEach((p, index) => { %>
              <tr>
                <td><%= index + 1 %></td>

                <td>
                  <img 
                    src="/Uploads/<%= p.imagen %>" 
                    width="60" 
                    class="rounded shadow-sm border border-light"
                    alt="Imagen de <%= p.nombre %>">
                </td>

                <td class="fw-semibold nombre text-capitalize">
                  <%= p.nombre %>
                  <br>
                  <small>
                    <span class="badge bg-secondary">Actual: $<%= p.precio_actual %></span>
                    <span class="badge bg-info">Viejo: $<%= p.precio_viejo %></span>
                    <span class="badge bg-primary">Nuevo: $<%= p.precio_nuevo %></span>
                  </small>
                </td>

                <td class="categoria text-capitalize"><%= p.categoria %></td>
                <td>$<%= p.precio_compra.toFixed(2) %></td>
                <td>$<%= p.precio_venta.toFixed(2) %></td>

                <td>
                  <% if (p.stock <= 5) { %>
                    <span class="badge bg-danger"><%= p.stock %> ⚠ URGENTE</span>
                  <% } else if (p.stock <= 10) { %>
                    <span class="badge bg-warning text-dark"><%= p.stock %> ⚠ Bajo</span>
                  <% } else { %>
                    <%= p.stock %>
                  <% } %>
                </td>

                <td><%= p.unidad %></td>

                <% if (user && user.role !== 'vendedor') { %>
                  <td>
                    <% if (user.role === 'administrador') { %>
                      <a href="/productos/edit/<%= p._id %>" class="btn btn-outline-success btn-sm mb-1"><i class="fas fa-edit"></i></a>
                      <a href="/productos/delete/<%= p._id %>" class="btn btn-outline-danger btn-sm mb-1"
                         onclick="return confirm('¿Eliminar este producto?');"><i class="fas fa-trash"></i></a>
                      <a href="/productos/add-merma/<%= p._id %>" class="btn btn-outline-warning btn-sm mb-1">
                          <i class="fas fa-exclamation-triangle"></i> Merma </a>                                                                            
                    <% } else if (user.role === 'bodeguero') { %>
                      <a href="/productos/add-merma/<%= p._id %>" class="btn btn-outline-warning btn-sm mb-1">
                          <i class="fas fa-exclamation-triangle"></i> Merma
                      </a>
                    <% } %>
                  </td>
                <% } %>

              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9" class="text-center text-muted py-4">Sin productos</td></tr>
          <% } %>

        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include('layout/footer') %>
